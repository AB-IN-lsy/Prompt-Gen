# åç«¯å¼€å‘æŒ‡å—

æœ¬é¡¹ç›®æä¾› Electron æ¡Œé¢ç«¯æ‰€éœ€çš„ Go åç«¯æœåŠ¡ï¼Œè´Ÿè´£ç”¨æˆ·æ³¨å†Œã€ç™»å½•ã€éªŒè¯ç è·å–ä»¥åŠç”¨æˆ·ä¿¡æ¯ç»´æŠ¤ã€‚

## æœ€è¿‘è¿›å±•

- æ–°å¢ç”¨æˆ·å¤´åƒå­—æ®µ `avatar_url`ï¼Œæ”¯æŒä¸Šä¼ åé€šè¿‡ `PUT /api/users/me` ä¿å­˜ã€‚
- æ–°å¢ `POST /api/uploads/avatar` æ¥å£ï¼Œå¯æ¥æ”¶ multipart å¤´åƒå¹¶è¿”å›å¯è®¿é—®çš„é™æ€åœ°å€ã€‚
- é»˜è®¤å¼€æ”¾ `/static/**` è·¯ç”±æ˜ å°„åˆ° `backend/public` ç›®å½•ï¼Œä¾›å¤´åƒç­‰èµ„æºç›´æ¥è®¿é—®ã€‚
- ç”¨æˆ·èµ„æ–™æ›´æ–°æ¥å£ç°ä¼šåœ¨ä¿å­˜å‰æ£€æŸ¥ç”¨æˆ·åã€é‚®ç®±å†²çªï¼Œå¹¶è¿”å›æ›´æ˜ç¡®çš„é”™è¯¯ã€‚
- æ³¨å†Œæ¥å£åœ¨é‚®ç®±ã€ç”¨æˆ·ååŒæ—¶å†²çªæ—¶ä¼šé€šè¿‡ `error.details.fields` è¿”å›å®Œæ•´å­—æ®µåˆ—è¡¨ï¼Œæ–¹ä¾¿å‰ç«¯é€é¡¹æç¤ºã€‚
- `PUT /api/users/me` æ”¯æŒæ˜¾å¼ä¼ å…¥ç©ºå­—ç¬¦ä¸²æ¸…ç©ºå¤´åƒï¼Œä¾¿äºç”¨æˆ·æ’¤é”€å·²ä¸Šä¼ çš„å¤´åƒå›¾ç‰‡ã€‚
- å•å…ƒæµ‹è¯•è¦†ç›– `UserService.UpdateProfile`ï¼Œç¡®ä¿èµ„æ–™æ›´æ–°é€»è¾‘ç¨³å®šã€‚
- æ–°å¢é‚®ç®±éªŒè¯æµç¨‹ï¼Œæ³¨å†Œåä¼šå‘æ”¾ä¸€æ¬¡æ€§éªŒè¯ä»¤ç‰Œï¼›é‚®ç®±æœªéªŒè¯å‰æ— æ³•ç™»å½•ã€‚
- æ³¨å†ŒæˆåŠŸä¼šç«‹å³è°ƒç”¨é‚®ä»¶å‘é€å™¨å‘å‡ºéªŒè¯é‚®ä»¶ï¼Œå¹¶åœ¨å“åº”ä¸­è¿”å› `remaining_attempts`ï¼Œå‰ç«¯å¯ç”¨ä»¥åˆ·æ–° UI æç¤ºã€‚
- ç»Ÿä¸€é‚®ç®±éªŒè¯é¢‘æ§ä¸éªŒè¯ç é™æµï¼Œå®ç° Redis/å†…å­˜åŒå®ç°çš„ `ratelimit.Limiter`ï¼Œæ”¯æŒ `EMAIL_VERIFICATION_LIMIT`ã€`EMAIL_VERIFICATION_WINDOW` è‡ªå®šä¹‰é˜ˆå€¼ã€‚
- é‚®ç®±éªŒè¯ä¸å›¾å½¢éªŒè¯ç æ¥å£è¿”å›å‰©ä½™å°è¯•æ¬¡æ•°ï¼ˆ`remaining_attempts`ï¼‰ï¼Œè¢«é™æµæ—¶é™„å¸¦å†·å´ç§’æ•°ï¼ˆ`retry_after_seconds`ï¼‰ï¼Œä¾¿äºå‰ç«¯å±•ç¤ºå‰©ä½™æœºä¼šä¸ç­‰å¾…æ—¶é—´ã€‚
- é‚®ä»¶å‘é€æ–°å¢é˜¿é‡Œäº‘ DirectMail å‘ä¿¡å™¨ï¼Œä¼˜å…ˆä½¿ç”¨ DirectMailï¼Œæœªé…ç½®æ—¶è‡ªåŠ¨å›é€€åˆ° SMTPã€‚
- å¯åŠ¨æµç¨‹æ‹†åˆ†ä¸º `internal/app.InitResources`ï¼ˆè´Ÿè´£è¿æ¥/è¿ç§»ï¼‰ä¸ `internal/bootstrap.BuildApplication`ï¼ˆè´Ÿè´£è£…é…ä¾èµ–ï¼‰ï¼Œæå‡èŒè´£æ¸…æ™°åº¦ã€‚
- æ–°å¢ `/api/models` ç³»åˆ—æ¥å£ï¼Œæ”¯æŒæ¨¡å‹å‡­æ®çš„åˆ›å»ºã€æŸ¥çœ‹ã€æ›´æ–°ä¸åˆ é™¤ï¼ŒAPI Key ä¼šåœ¨å…¥åº“å‰åŠ å¯†ã€‚
- å¼•å…¥ `MODEL_CREDENTIAL_MASTER_KEY` ç¯å¢ƒå˜é‡ï¼Œä½¿ç”¨ AES-256-GCM åŠ è§£å¯†ç”¨æˆ·æäº¤çš„æ¨¡å‹å‡­æ®ã€‚
- æ•°æ®åº“è‡ªåŠ¨è¿ç§»åŒ…å« `user_model_credentials` è¡¨ï¼ŒæœåŠ¡å¯åŠ¨å³å¯åˆ›å»ºæ‰€éœ€æ•°æ®ç»“æ„ã€‚
- æ¨¡å‹å‡­æ®ç¦ç”¨æˆ–åˆ é™¤æ—¶ï¼Œä¼šè‡ªåŠ¨æ¸…ç†ç”¨æˆ·åå¥½çš„ `preferred_model`ï¼Œé¿å…æŒ‡å‘ä¸å¯ç”¨çš„æ¨¡å‹ï¼›`PUT /api/users/me` ä¹Ÿä¼šéªŒè¯åå¥½æ¨¡å‹æ˜¯å¦å­˜åœ¨å¹¶å·²å¯ç”¨ã€‚
- æ–°å¢ `infra/model/deepseek` æ¨¡å—ä¸ `Service.InvokeDeepSeekChatCompletion`ï¼Œå¯ä½¿ç”¨å­˜é‡å‡­æ®ç›´æ¥å‘ DeepSeek Chat Completion API å‘èµ·è°ƒç”¨ã€‚

## ç¯å¢ƒå˜é‡

### è¿è¡Œå¿…éœ€

| å˜é‡ | ä½œç”¨ |
| --- | --- |
| `SERVER_PORT` | HTTP æœåŠ¡ç›‘å¬ç«¯å£ï¼Œé»˜è®¤ `9090` |
| `JWT_SECRET` | JWT ç­¾åå¯†é’¥ï¼Œå¿…å¡« |
| `JWT_ACCESS_TTL` | è®¿é—®ä»¤ç‰Œæœ‰æ•ˆæœŸï¼Œå¦‚ `15m` |
| `JWT_REFRESH_TTL` | åˆ·æ–°ä»¤ç‰Œæœ‰æ•ˆæœŸï¼Œå¦‚ `168h` |
| `NACOS_ENDPOINT` | Nacos åœ°å€ï¼Œå½¢å¦‚ `ip:port` |
| `NACOS_USERNAME` / `NACOS_PASSWORD` | Nacos ç™»å½•å‡­è¯ |
| `NACOS_GROUP` / `NACOS_NAMESPACE` | Nacos è¯»å– MySQL é…ç½®æ‰€ç”¨çš„åˆ†ç»„ä¸å‘½åç©ºé—´ |
| `MYSQL_CONFIG_DATA_ID` / `MYSQL_CONFIG_GROUP` | Nacos ä¸­ MySQL é…ç½®çš„ DataId ä¸ Group |
| `MODEL_CREDENTIAL_MASTER_KEY` | 32 å­—èŠ‚ä¸»å¯†é’¥ï¼ˆéœ€ä½¿ç”¨ Base64 ç¼–ç åå†™å…¥ï¼‰ï¼Œç”¨äºåŠ è§£å¯†æ¨¡å‹ API Key |

### éªŒè¯ç ä¸ Redis

| å˜é‡ | ä½œç”¨ |
| --- | --- |
| `REDIS_ENDPOINT` | Redis åœ°å€ï¼Œå¯ç”¨éªŒè¯ç æ—¶å¿…å¡« |
| `REDIS_PASSWORD` / `REDIS_DB` | Redis è®¤è¯å’Œ DBï¼Œä¸‹åˆ’çº¿ç•™ç©ºå³å¯èµ°é»˜è®¤å€¼ |
| `CAPTCHA_ENABLED` | è®¾ç½®ä¸º `1` æ—¶å¼€å¯éªŒè¯ç èƒ½åŠ› |
| `CAPTCHA_PREFIX` | Redis Key å‰ç¼€ï¼Œé»˜è®¤ `captcha` |
| `CAPTCHA_TTL` | éªŒè¯ç æœ‰æ•ˆæœŸï¼Œä¾‹å¦‚ `5m` |
| `CAPTCHA_LENGTH` | éªŒè¯ç é•¿åº¦ |
| `CAPTCHA_WIDTH` / `CAPTCHA_HEIGHT` | å›¾ç‰‡å°ºå¯¸ |
| `CAPTCHA_MAX_SKEW` / `CAPTCHA_DOT_COUNT` | å›¾ç‰‡æ‰­æ›²ã€å™ªç‚¹å‚æ•° |
| `CAPTCHA_RATE_LIMIT_PER_MIN` | æ¯ä¸ª IP åœ¨çª—å£å†…å…è®¸è¯·æ±‚æ¬¡æ•° |
| `CAPTCHA_RATE_LIMIT_WINDOW` | é™æµçª—å£æ—¶é•¿ï¼Œä¾‹å¦‚ `1m` |

### é‚®ç®±éªŒè¯ä¸é‚®ä»¶å‘é€

| å˜é‡ | ä½œç”¨ |
| --- | --- |
| `APP_PUBLIC_BASE_URL` | å‰ç«¯å…¬å…±åœ°å€ï¼Œç”¨äºæ‹¼æ¥éªŒè¯é“¾æ¥ï¼Œä¾‹å¦‚ `https://app.example.com` |
| `EMAIL_VERIFICATION_LIMIT` | é‚®ç®±éªŒè¯é‡å‘é™é¢‘æ¬¡æ•°ï¼Œé»˜è®¤ `5` |
| `EMAIL_VERIFICATION_WINDOW` | é‚®ç®±éªŒè¯é™é¢‘çª—å£æ—¶é•¿ï¼Œé»˜è®¤ `1h` |

#### SMTP å‘ä¿¡ï¼ˆå¯é€‰ï¼‰

| å˜é‡ | ä½œç”¨ |
| --- | --- |
| `SMTP_HOST` / `SMTP_PORT` | SMTP æœåŠ¡åœ°å€ä¸ç«¯å£ |
| `SMTP_USERNAME` / `SMTP_PASSWORD` | SMTP ç™»å½•å‡­è¯ï¼ˆåŒ¿åæ—¶å¯ç•™ç©ºç”¨æˆ·å/å¯†ç ï¼‰ |
| `SMTP_FROM` | å‘ä¿¡äººé‚®ç®±åœ°å€ |

#### é˜¿é‡Œäº‘ DirectMailï¼ˆå¯é€‰ï¼‰

| å˜é‡ | ä½œç”¨ |
| --- | --- |
| `ALIYUN_DM_ACCESS_KEY_ID` / `ALIYUN_DM_ACCESS_KEY_SECRET` | é˜¿é‡Œäº‘è®¿é—®å¯†é’¥å¯¹ |
| `ALIYUN_DM_REGION_ID` | DirectMail å®ä¾‹æ‰€åœ¨åŒºåŸŸï¼Œä¾‹å¦‚ `cn-hangzhou` |
| `ALIYUN_DM_ENDPOINT` | DirectMail API è®¿é—®åŸŸåï¼Œé»˜è®¤ `dm.aliyuncs.com` |
| `ALIYUN_DM_ACCOUNT_NAME` | ç®¡ç†æ§åˆ¶å°é…ç½®çš„å‘ä¿¡åœ°å€ï¼ˆAccountNameï¼‰ |
| `ALIYUN_DM_FROM_ALIAS` | å‘ä¿¡äººåˆ«åï¼Œå¯é€‰ |
| `ALIYUN_DM_TAG_NAME` | é‚®ä»¶æ ‡ç­¾ï¼Œå¯é€‰ |
| `ALIYUN_DM_REPLY_TO_ADDRESS` | æ˜¯å¦å¯ç”¨å›ä¿¡åœ°å€ï¼ˆ`true` / `false`ï¼‰ |
| `ALIYUN_DM_ADDRESS_TYPE` | å‘ä¿¡åœ°å€ç±»å‹ï¼ˆ`0` éšæœºè´¦å·ï¼Œ`1` ç‹¬ç«‹è´¦å·ï¼‰ |

DirectMail ç¯å¢ƒå˜é‡é½å…¨æ—¶ï¼Œ`initEmailSender` ä¼šä¼˜å…ˆå®ä¾‹åŒ–é˜¿é‡Œäº‘å®¢æˆ·ç«¯ï¼›å¦åˆ™é€€å› SMTP å‘ä¿¡å™¨ï¼Œå†ä¸æ»¡è¶³åˆ™ä»…å†™æ—¥å¿—ã€‚

åœ¨ä»“åº“æ ¹ç›®å½•ä¸­å¤åˆ¶ `.env.example` ä¸º `.env.local` å¡«å…¥çœŸå®å€¼ï¼ŒæœåŠ¡å¯åŠ¨æ—¶ä¼šè‡ªåŠ¨åŠ è½½ã€‚

> **æç¤ºï¼š** åˆ·æ–°ä»¤ç‰Œé»˜è®¤å­˜å…¥ Redisï¼›è‹¥æœªé…ç½® Redisï¼Œåˆ™é€€åŒ–ä¸ºè¿›ç¨‹å†…å†…å­˜å­˜å‚¨ï¼Œé€‚åˆå¼€å‘ç¯å¢ƒï¼Œä½†æœåŠ¡é‡å¯ååˆ·æ–°ä»¤ç‰Œä¼šå…¨éƒ¨å¤±æ•ˆã€‚

```powershell
Copy-Item ..\..\.env.example ..\..\.env.local -Force
```

## é‚®ä»¶å‘é€è°ƒè¯•

é˜¿é‡Œäº‘ DirectMail åœ¨æœ¬åœ°å¼€å‘æ—¶å¯ä»¥ä½¿ç”¨è¾…åŠ©å‘½ä»¤å¿«é€Ÿå‘ä¿¡ç¡®è®¤é…ç½®ï¼š

```powershell
go run ./backend/cmd/sendmail -to you@example.com -name "æµ‹è¯•è´¦å·"
```

å‘½ä»¤ä¼šåŠ è½½ `.env.local`ï¼Œæ„é€ ä¸€å°éªŒè¯é‚®ä»¶å‘é€è‡³æŒ‡å®šåœ°å€ï¼Œå¹¶åœ¨ç»ˆç«¯æ‰“å°ç”Ÿæˆçš„ tokenã€‚å¯é…åˆå‰ç«¯éªŒè¯é¡µé¢è¿›è¡Œæ‰‹åŠ¨æµ‹è¯•ã€‚

## è·¨åŸŸè®¿é—®ï¼ˆCORSï¼‰

### ä¸ºä»€ä¹ˆéœ€è¦å®ƒï¼Ÿ

æµè§ˆå™¨æœ‰ä¸€é“â€œåŒæºç­–ç•¥â€å®‰å…¨é™åˆ¶ï¼šé¡µé¢åªèƒ½è®¿é—®å’Œè‡ªå·±åè®®ã€åŸŸåã€ç«¯å£å®Œå…¨ç›¸åŒçš„æ¥å£ã€‚æˆ‘ä»¬çš„åœºæ™¯é‡Œå­˜åœ¨å¤šä¸ªâ€œæ¥æºâ€ï¼š

1. `npm run dev` å¯åŠ¨çš„ Vite é¡µé¢å¯¹å¤–åœ°å€æ˜¯ `http://localhost:5173`ã€‚
2. `npm run preview` ä¼šåœ¨ `http://localhost:4173` å¯åŠ¨æ¨¡æ‹Ÿç”Ÿäº§çš„é™æ€æœåŠ¡å™¨ã€‚
3. Electron å¼€å‘æ¨¡å¼ä¸‹ï¼Œä¸»çª—å£ç›´æ¥è½½å…¥ Vite åœ°å€ï¼›æ‰“åŒ…ååˆ™ä¼šä»¥ `file://...` å½¢å¼æ‰“å¼€æœ¬åœ° `dist/index.html`ã€‚æ­¤æ—¶æµè§ˆå™¨å‘é€çš„ `Origin` ä¼šå˜æˆ `null`ã€‚

åç«¯ç›‘å¬åœ¨ `http://localhost:9090`ï¼Œä¸Šè¿°æ¥æºåœ¨è®¿é—® `/api/...` æ—¶éƒ½å±äºâ€œè·¨åŸŸâ€ã€‚å¦‚æœæ²¡æœ‰é¢å¤–é…ç½®ï¼Œæµè§ˆå™¨ä¼šæ‹’ç»è¿™äº›è¯·æ±‚ï¼Œè¡¨ç°ä¸ºå‰ç«¯æ”¶åˆ° `CORS error` æˆ–ç›´æ¥å¤±è´¥ã€‚

### é¡¹ç›®ä¸­çš„å¤„ç†æ–¹å¼

æˆ‘ä»¬åœ¨ `internal/server/router.go` ä¸­å¯ç”¨äº† [CORSï¼ˆCross-Origin Resource Sharingï¼‰](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/CORS) ä¸­é—´ä»¶ï¼Œå¹¶å…è®¸ä»¥ä¸‹æ¥æºè®¿é—®ï¼š

- `http://localhost:<ä»»ä½•ç«¯å£>`ï¼ˆè¦†ç›– 5173ã€4173 åŠå…¶ä»–æœ¬åœ°è°ƒè¯•ç«¯å£ï¼‰
- `http://127.0.0.1:<ä»»ä½•ç«¯å£>`ï¼ˆåŒä¸Šï¼Œåªæ˜¯è®¿é—®æ–¹å¼ä¸åŒï¼‰
- `null`ï¼ˆElectron ä»¥ `file://` æ‰“å¼€é¡µé¢æ—¶æµè§ˆå™¨å¸¦ä¸Šçš„ç‰¹æ®Šå€¼ï¼‰

ä¸­é—´ä»¶ä¼šè‡ªåŠ¨æ·»åŠ  `Access-Control-Allow-Origin`ã€`Access-Control-Allow-Methods` ç­‰å“åº”å¤´ï¼Œä»è€Œå‘Šè¯‰æµè§ˆå™¨â€œè¿™ç±»è·¨åŸŸè¯·æ±‚æ˜¯å…è®¸çš„â€ã€‚å¦‚éœ€è”è°ƒæ›´å¤šåŸŸåï¼Œåªéœ€æ‰©å±• `AllowOriginFunc` æˆ–æ”¹ä¸ºè¯»å–ç¯å¢ƒå˜é‡å³å¯ã€‚

## å¯¹å¤– API

| æ–¹æ³• | è·¯å¾„ | æè¿° | è¯·æ±‚å‚æ•° |
| --- | --- | --- | --- |
| `GET` | `/api/auth/captcha` | è·å–å›¾å½¢éªŒè¯ç  | æ— ï¼›æŒ‰å®¢æˆ·ç«¯ IP æ§åˆ¶é™æµ |
| `POST` | `/api/auth/register` | ç”¨æˆ·æ³¨å†Œ | JSONï¼š`username`ã€`email`ã€`password`ã€`avatar_url`ã€`captcha_id`ã€`captcha_code`ï¼ˆéªŒè¯ç å¼€å¯æ—¶å¿…å¡«ï¼‰ |
| `POST` | `/api/auth/login` | ç”¨æˆ·ç™»å½• | JSONï¼š`email`ã€`password` |
| `POST` | `/api/auth/verify-email/request` | é‡æ–°å‘é€é‚®ç®±éªŒè¯ä»¤ç‰Œ | JSONï¼š`email` |
| `POST` | `/api/auth/verify-email/confirm` | ä½¿ç”¨ token å®Œæˆé‚®ç®±éªŒè¯ | JSONï¼š`token` |
| `POST` | `/api/auth/refresh` | åˆ·æ–°è®¿é—®ä»¤ç‰Œ | JSONï¼š`refresh_token` |
| `POST` | `/api/auth/logout` | æ’¤é”€åˆ·æ–°ä»¤ç‰Œ | JSONï¼š`refresh_token` |
| `GET` | `/api/users/me` | è·å–å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯ | éœ€é™„å¸¦ `Authorization: Bearer <token>` |
| `PUT` | `/api/users/me` | æ›´æ–°å½“å‰ç”¨æˆ·ä¿¡æ¯ä¸åå¥½è®¾ç½® | JSONï¼š`username`ã€`email`ã€`avatar_url`ã€`preferred_model`ã€`sync_enabled` |
| `POST` | `/api/uploads/avatar` | ä¸Šä¼ å¤´åƒæ–‡ä»¶å¹¶è¿”å›é™æ€åœ°å€ | éœ€ç™»å½•ï¼›multipart è¡¨å•ï¼š`avatar` æ–‡ä»¶å­—æ®µ |
| `GET` | `/api/models` | åˆ—å‡ºå½“å‰ç”¨æˆ·çš„æ¨¡å‹å‡­æ® | éœ€ç™»å½• |
| `POST` | `/api/models` | æ–°å¢æ¨¡å‹å‡­æ®å¹¶åŠ å¯†å­˜å‚¨ | JSONï¼š`provider`ã€`label`ã€`api_key`ã€`metadata` |
| `PUT` | `/api/models/:id` | æ›´æ–°æ¨¡å‹å‡­æ®ï¼ˆå¯æ›¿æ¢ API Keyï¼‰ | JSONï¼š`label`ã€`api_key`ã€`metadata` |
| `DELETE` | `/api/models/:id` | åˆ é™¤æ¨¡å‹å‡­æ® | æ—  |

### æ¨¡å‹å‡­æ®å­—æ®µè¯´æ˜ä¸ DeepSeek ç¤ºä¾‹

- **provider**ï¼šæœåŠ¡å•†ä»£å·ï¼Œä¿æŒå°å†™ï¼Œç›®å‰é™å®šä¸º `deepseek` æˆ– `volcengine`ã€‚  
- **model_key**ï¼šç”¨æˆ·è‡ªå®šä¹‰çš„æ¨¡å‹æ ‡è¯†ï¼Œéœ€åœ¨è´¦å·èŒƒå›´å†…å”¯ä¸€ï¼Œåç«¯ä¹Ÿä¼šç”¨å®ƒä½œä¸ºé»˜è®¤çš„ `model` å­—æ®µä¼ ç»™å¤§æ¨¡å‹ï¼Œä¾‹å¦‚ `deepseek-chat`ã€‚  
- **display_name**ï¼šå‰ç«¯å±•ç¤ºåç§°ï¼Œå¯å†™æˆ `DeepSeek Chatï¼ˆå›¢é˜Ÿå¯†é’¥ï¼‰`ã€‚  
- **base_url**ï¼šå¯é€‰ï¼Œè¦†ç›–é»˜è®¤çš„ `https://api.deepseek.com/v1`ï¼Œå½“ä½ ä½¿ç”¨ä»£ç†æˆ–ä¼ä¸šç½‘å…³æ—¶å¡«å†™ã€‚  
- **api_key**ï¼šå®é™…çš„è®¿é—®å¯†é’¥ï¼Œåç«¯å…¥åº“å‰ä¼šç”¨ `MODEL_CREDENTIAL_MASTER_KEY` åŠ å¯†ã€‚  
- **extra_config**ï¼šå¯é€‰ JSONï¼Œå¯¹åº” DeepSeek `chat/completions` çš„å¯é€‰å‚æ•°ï¼ˆå¦‚ `max_tokens`ã€`temperature`ã€`response_format` ç­‰ï¼‰ï¼Œæœªåœ¨è¯·æ±‚ä½“é‡Œæ˜¾å¼æä¾›æ—¶ä¼šè‡ªåŠ¨å›å¡«ã€‚

> å½“å‰åç«¯å·²æ”¯æŒ DeepSeek ä¸ç«å±±å¼•æ“ï¼ˆVolcengineï¼‰ï¼›å…¶ä½™æä¾›æ–¹å°†åœ¨åç»­è¿­ä»£ä¸­é€æ­¥æ¥å…¥ã€‚

ä¾‹å¦‚å°† DeepSeek å®˜æ–¹ Demo æ³¨å†Œè¿›ç³»ç»Ÿï¼Œå¯åœ¨â€œæ–°å¢æ¨¡å‹â€è¡¨å•è¾“å…¥ï¼š

```json
 {
  "provider": "deepseek",
  "model_key": "deepseek-chat",
  "display_name": "DeepSeek Chatï¼ˆä¸»åŠ›ï¼‰",
  "base_url": "https://api.deepseek.com/v1",
  "api_key": "sk-...æ›¿æ¢æˆè‡ªå·±çš„å¯†é’¥...",
  "extra_config": {
    "max_tokens": 4096,
    "temperature": 1,
    "response_format": {
      "type": "text"
    }
  }
}
```

å¦‚æœéœ€è¦æ¥å…¥ç«å±±å¼•æ“ï¼ˆæ–¹èˆŸ Doubaoï¼‰ï¼Œå¯ä»¥å‚è€ƒä»¥ä¸‹ç¤ºä¾‹ï¼š

```json
{
  "provider": "volcengine",
  "model_key": "doubao-1-5-thinking-pro-250415",
  "display_name": "Volcengine Doubao",
  "base_url": "https://ark.cn-beijing.volces.com/api/v3",
  "api_key": "<æ›¿æ¢ä¸ºä½ çš„æ–¹èˆŸ API Key>",
  "extra_config": {
    "max_tokens": 4096,
    "temperature": 1
  }
}
```

å‰ç«¯åœ¨å·¥ä½œå°æˆ–è®¾ç½®é¡µè§¦å‘æ¨¡å‹è°ƒç”¨æ—¶ï¼Œä¼šé€šè¿‡ `InvokeDeepSeekChatCompletion` æµç¨‹å®Œæˆä»¥ä¸‹åŠ¨ä½œï¼š

1. è¯»å–å¹¶æ ¡éªŒæ¨¡å‹å‡­æ®ï¼Œç¡®è®¤çŠ¶æ€ä¸º `enabled`ã€‚  
2. ä½¿ç”¨ AES-256-GCM è§£å¯† API Keyï¼Œå¹¶æ ¹æ® `base_url` åˆ›å»º DeepSeek å®¢æˆ·ç«¯ã€‚  
3. åˆå¹¶ `extra_config` ä¸æœ¬æ¬¡è°ƒç”¨æ˜¾å¼ä¼ å…¥çš„å‚æ•°ï¼Œå°†ç¼ºå¤±å­—æ®µï¼ˆå¦‚ `max_tokens`ï¼‰è¡¥é½ã€‚  
4. å‘é€ `POST {base_url}/chat/completions` è¯·æ±‚å¹¶è¿”å›æ ‡å‡†ç»“æ„ã€‚  
5. è‹¥ DeepSeek è¿”å› `4xx/5xx`ï¼Œä¼šå°è£…ä¸º `deepseek.APIError`ï¼ŒåŒ…å« `status_code` / `type` / `code` ä¿¡æ¯ï¼Œæ–¹ä¾¿ä¸Šå±‚å®šä½é—®é¢˜ã€‚
6. è®¾ç½®é¡µæ–°å¢äº†â€œæµ‹è¯•è¿é€šæ€§â€æ“ä½œï¼Œä¼šè°ƒç”¨ `POST /api/models/{id}/test`ï¼ŒæˆåŠŸåæ›´æ–° `last_verified_at` ä»¥ä¾¿è¿½è¸ªæœ€è¿‘ä¸€æ¬¡éªŒè¯æ—¶é—´ã€‚

å“åº”ç¤ºä¾‹ï¼š

```json
{
  "id": "7bce4a57-c144-4162-a3f9-1bde7b7f195f",
  "object": "chat.completion",
  "created": 1760181608,
  "model": "deepseek-chat",
  "choices": [
    {
      "index": 0,
      "message": {
        "role": "assistant",
        "content": "Hello! How can I assist you today? ğŸ˜Š"
      },
      "finish_reason": "stop"
    }
  ],
  "usage": {
    "prompt_tokens": 10,
    "completion_tokens": 11,
    "total_tokens": 21
  }
}
```

### ç«å±±å¼•æ“ï¼ˆVolcengineï¼‰é€‚é…è¯´æ˜

- **åŒå‘å…¼å®¹**ï¼šæ¨¡å‹ç®¡ç†çš„æ–°å¢ / æ›´æ–° / è¿é€šæ€§æµ‹è¯•æ¥å£åŒæ—¶æ”¯æŒ `deepseek` ä¸ `volcengine`ï¼Œ`POST /api/models/:id/test` ä¼šè‡ªåŠ¨æ ¹æ® provider è°ƒç”¨å¯¹åº”å®¢æˆ·ç«¯ã€‚
- **é»˜è®¤é…ç½®å…œåº•**ï¼šæœªæ˜¾å¼å¡«å†™ `model` æ—¶ä¼šä½¿ç”¨å‡­æ®é‡Œçš„ `model_key`ï¼ŒDeepSeek é»˜è®¤ `deepseek-chat`ï¼Œç«å±±å¼•æ“é»˜è®¤ `doubao-1-5-thinking-pro-250415`ï¼›Base URL ä¸å¡«å†™åˆ™åˆ†åˆ«è½åˆ° `https://api.deepseek.com/v1` ä¸ `https://ark.cn-beijing.volces.com/api/v3`ã€‚
- **å“åº”å­—æ®µæ˜ å°„**ï¼šæ–¹èˆŸè¿”å›çš„ `service_tier` ä¼šæ˜ å°„åˆ° `system_fingerprint`ï¼Œ`reasoning_content` ä»¥ `choices[*].logprobs.reasoning_content` å½¢å¼é€å‡ºï¼Œå…¶ä½™ token ç»Ÿè®¡ã€åŸå§‹ JSON å…¨é‡ä¿å­˜åœ¨ `usage` ä¸ `raw` ä¸­ï¼Œå‰ç«¯å¯ç»Ÿä¸€æ¸²æŸ“ã€‚
- **ç¤ºä¾‹**ï¼šæ–°å¢ç«å±±å¼•æ“æ¨¡å‹æ—¶å¯å‚è€ƒä¸Šæ–‡ JSON ç¤ºä¾‹ï¼Œå°† `provider` æ”¹ä¸º `volcengine`ã€`api_key` æ›¿æ¢ä¸ºå®é™…å‡­æ®å³å¯ã€‚
- **å‰ç«¯è”åŠ¨**ï¼šè®¾ç½®é¡µæ¨¡å‹å¡ç‰‡ä¼šæ ¹æ® provider è‡ªåŠ¨å¡«å……å¸¸ç”¨é»˜è®¤å€¼ï¼Œå¹¶æ”¯æŒ DeepSeek/Volcengine çš„â€œæµ‹è¯•è¿é€šæ€§â€æŒ‰é’®ï¼Œæ–¹ä¾¿åœ¨ç•Œé¢ä¸Šç›´æ¥éªŒè¯å‡­æ®æ˜¯å¦å¯ç”¨ã€‚

### é™æ€èµ„æºä¸ä¸Šä¼ ç›®å½•

- æœåŠ¡å™¨å¯åŠ¨æ—¶ä¼šå°† `/static/**` æ˜ å°„åˆ°é¡¹ç›®å†…çš„ `backend/public` ç›®å½•ï¼Œå¤´åƒä¸Šä¼ é»˜è®¤å†™å…¥ `backend/public/avatars`ã€‚
- å¯ä»¥æ ¹æ®éœ€è¦æŒ‚è½½åˆ°å¯¹è±¡å­˜å‚¨æˆ– CDNï¼Œåªéœ€æ›¿æ¢ `UploadHandler` çš„å†™å…¥é€»è¾‘å¹¶è°ƒæ•´è¿”å›çš„ URLã€‚
- è‹¥è¿è¡Œåœ¨å®¹å™¨ç¯å¢ƒï¼Œè¯·ç¡®ä¿æŒ‚è½½è¯¥ç›®å½•æˆ–æ”¹ä¸ºå¤–éƒ¨å­˜å‚¨ï¼Œä»¥å…åº”ç”¨é‡å¯åä¸Šä¼ å†…å®¹ä¸¢å¤±ã€‚

æ¥å£è¿”å›ç»Ÿä¸€ç»“æ„ï¼š`success`ã€`data`ã€`error`ã€`meta`ã€‚é”™è¯¯ç è§ `internal/infra/common/response.go`ã€‚

### è®¤è¯æµç¨‹æ¦‚è§ˆ

- **æ³¨å†Œ**ï¼šé¦–æ¬¡åˆ›å»ºè´¦å·ã€‚æˆåŠŸåç«‹å³è¿”å›ä¸€å¯¹ `access_token`ï¼ˆçŸ­æœŸä½¿ç”¨ï¼‰å’Œ `refresh_token`ï¼ˆé•¿æœŸç»­æœŸç”¨ï¼‰ã€‚
- **ç™»å½•**ï¼šæäº¤é‚®ç®± + å¯†ç ï¼Œè¿”å›æ–°çš„ TokenPairï¼ˆä¼šè¦†ç›–æ—§çš„åˆ·æ–°ä»¤ç‰Œï¼‰ã€‚
- **è‡ªåŠ¨ç»­æœŸ**ï¼šå½“è®¿é—®æ¥å£æç¤º 401ï¼ˆaccess token è¿‡æœŸï¼‰æ—¶ï¼Œå‰ç«¯è°ƒç”¨ `/api/auth/refresh`ï¼Œå¸¦ä¸Šæ‰‹é‡Œçš„ refresh tokenã€‚
  - åˆ·æ–°æˆåŠŸåä¼šåŒæ—¶æ¢å‘æ–°çš„ access/refreshï¼Œå¹¶ä½¿æ—§çš„åˆ·æ–°ä»¤ç‰Œå¤±æ•ˆã€‚
  - å¦‚æœåˆ·æ–°ä»¤ç‰Œå·²è¿‡æœŸæˆ–è¢«æ³¨é”€ï¼Œæ¥å£è¿”å› 401ï¼Œå‰ç«¯éœ€è¦å¼•å¯¼ç”¨æˆ·é‡æ–°ç™»å½•ã€‚
- **ç™»å‡º**ï¼šè°ƒç”¨ `/api/auth/logout`ï¼ŒæœåŠ¡ç«¯åˆ é™¤åˆ·æ–°ä»¤ç‰Œè®°å½•ï¼Œé˜»æ­¢åç»­ç»­æœŸï¼›å‰ç«¯æ¸…ç†æœ¬åœ°ç¼“å­˜ã€‚

### æ¥å£è¯¦æƒ…

#### POST /api/auth/register

- **è¯·æ±‚ä½“**

  ```json
  {
    "username": "alice",
    "email": "alice@example.com",
    "password": "Passw0rd!",
    "captcha_id": "d2c1",
    "captcha_code": "7bz4"
  }
  ```

- **æˆåŠŸå“åº”**ï¼š`201`ï¼Œè¿”å›ç”¨æˆ·ä¿¡æ¯ä¸ TokenPairã€‚
- **å¸¸è§é”™è¯¯**ï¼šé‚®ç®±/ç”¨æˆ·åé‡å¤ï¼ˆ409ï¼‰ã€éªŒè¯ç ç¼ºå¤±/é”™è¯¯ï¼ˆ400ï¼‰ã€‚

#### GET /api/auth/captcha

- **ç”¨é€”**ï¼šè¿”å›å›¾å½¢éªŒè¯ç ä»¥åŠéªŒè¯ç  IDï¼Œä¾›æ³¨å†Œç­‰åœºæ™¯æ ¡éªŒã€‚
- **æˆåŠŸå“åº”**ï¼š`200`

  ```json
  {
    "success": true,
    "data": {
      "captcha_id": "...",
      "image": "data:image/png;base64,...",
      "remaining_attempts": 4
    }
  }
  ```

- **é™åˆ¶è¯´æ˜**ï¼šæŒ‰å®¢æˆ·ç«¯ IP é™æµï¼Œè¶…è¿‡é˜ˆå€¼ä¼šè¿”å› `429 Too Many Requests`ï¼Œå¿…è¦æ—¶è°ƒæ•´ `CAPTCHA_RATE_LIMIT_PER_MIN` ä¸ `CAPTCHA_RATE_LIMIT_WINDOW`ã€‚
- **æç¤ºä¿¡æ¯**ï¼š`remaining_attempts` è¡¨ç¤ºå½“å‰çª—å£å†…å‰©ä½™åˆ·æ–°æ¬¡æ•°ï¼Œè¢«é™æµæ—¶å“åº”ä½“ä¼šåœ¨ `error.details` ä¸­é™„å¸¦ `retry_after_seconds` ä¸ `remaining_attempts: 0`ã€‚

#### POST /api/auth/login

- **è¯·æ±‚ä½“**

  ```json
  {
    "email": "alice@example.com",
    "password": "Passw0rd!"
  }
  ```

- **æˆåŠŸå“åº”**ï¼š`200`ï¼Œè¿”å›ç”¨æˆ·ä¿¡æ¯ä¸æ–°çš„ TokenPairã€‚
- **å¸¸è§é”™è¯¯**ï¼šè´¦å·ä¸å­˜åœ¨æˆ–å¯†ç é”™è¯¯ â†’ `401` + `ErrInvalidLogin`ã€‚
- **é‚®ç®±æœªéªŒè¯**ï¼šè¿”å› `403` + `EMAIL_NOT_VERIFIED`ï¼Œéœ€å…ˆå®Œæˆé‚®ç®±éªŒè¯ã€‚

#### POST /api/auth/verify-email/request

- **ç”¨é€”**ï¼šé‡æ–°å‘é€é‚®ç®±éªŒè¯é‚®ä»¶/ä»¤ç‰Œï¼Œé»˜è®¤ 24 å°æ—¶å†…æœ‰æ•ˆã€‚
- **è¯·æ±‚ä½“**

  ```json
  {
    "email": "alice@example.com"
  }
  ```

- **æˆåŠŸå“åº”**ï¼š`200`ã€‚å¼€å‘ç¯å¢ƒä¼šåœ¨ `data.token` è¿”å›ä¸€æ¬¡æ€§ Tokenï¼Œä¾¿äºæµ‹è¯•ï¼›`data.remaining_attempts` æç¤ºå½“å‰çª—å£å‰©ä½™å¯ç”¨æ¬¡æ•°ï¼Œè¢«é™æµæ—¶ `error.details.retry_after_seconds` ç»™å‡ºå†·å´æ—¶é—´ã€‚
- **å¸¸è§é”™è¯¯**ï¼šé‚®ç®±å·²é€šè¿‡éªŒè¯ â†’ `409` + `EMAIL_ALREADY_VERIFIED`ã€‚

#### POST /api/auth/verify-email/confirm

- **ç”¨é€”**ï¼šæäº¤é‚®ä»¶ä¸­çš„ä¸€æ¬¡æ€§ tokenï¼Œå®Œæˆé‚®ç®±éªŒè¯ã€‚
- **è¯·æ±‚ä½“**

  ```json
  {
    "token": "0c1e1fa5-1c6d-4a6a-8c5d-8f3e7b5c2ee1"
  }
  ```

- **æˆåŠŸå“åº”**ï¼š`204`ã€‚
- **å¸¸è§é”™è¯¯**ï¼štoken è¿‡æœŸã€å·²ä½¿ç”¨æˆ–ä¸å­˜åœ¨ â†’ `400` + `VERIFICATION_TOKEN_INVALID`ã€‚

#### POST /api/auth/refresh

- **é€‚ç”¨åœºæ™¯**ï¼šaccess token å·²è¿‡æœŸï¼Œä½† refresh token ä»åœ¨æœ‰æ•ˆæœŸå†…ã€‚
- **è¯·æ±‚ä½“**

  ```json
  {
    "refresh_token": "<æ—§çš„åˆ·æ–°ä»¤ç‰Œ>"
  }
  ```

- **æˆåŠŸå“åº”**ï¼š`200`

  ```json
  {
    "success": true,
    "data": {
      "tokens": {
        "access_token": "...",
        "refresh_token": "...",
        "expires_in": 900
      }
    }
  }
  ```

  åˆ·æ–°åæ—§çš„åˆ·æ–°ä»¤ç‰Œç«‹å³å¤±æ•ˆã€‚

- **å¸¸è§é”™è¯¯**ï¼šè¯·æ±‚ç¼ºå°‘ `refresh_token`ï¼ˆ400ï¼‰ã€åˆ·æ–°ä»¤ç‰Œè¿‡æœŸ/å·²ç™»å‡º/è¢«åŠé”€ï¼ˆ401ï¼‰ã€‚

#### POST /api/auth/logout

- **ç”¨é€”**ï¼šç”¨æˆ·ä¸»åŠ¨é€€å‡ºç™»å½•æˆ–åå°å¼ºåˆ¶å¤±æ•ˆåˆ·æ–°ä»¤ç‰Œã€‚
- **è¯·æ±‚ä½“**

  ```json
  {
    "refresh_token": "<å½“å‰åˆ·æ–°ä»¤ç‰Œ>"
  }
  ```

- **æˆåŠŸå“åº”**ï¼š`204`ï¼ˆæ— å†…å®¹ï¼‰ã€‚æ­¤åè¯¥åˆ·æ–°ä»¤ç‰Œæ— æ³•å†æ¢å–æ–°çš„ access tokenã€‚
- **å¸¸è§é”™è¯¯**ï¼šè¯·æ±‚ç¼ºå°‘æˆ–æä¾›äº†æ— æ•ˆçš„åˆ·æ–°ä»¤ç‰Œ â†’ `400 / 401`ã€‚

#### GET /api/users/me

- **ç”¨é€”**ï¼šè¿”å›å½“å‰ç™»å½•ç”¨æˆ·çš„åŸºç¡€èµ„æ–™å’Œåå¥½è®¾ç½®ï¼Œå‰ç«¯åˆå§‹åŒ–ä¸åˆ·æ–°é¡µé¢æ—¶ä¼šè°ƒç”¨ã€‚
- **è¯·æ±‚å¤´**ï¼š`Authorization: Bearer <access_token>`ã€‚
- **æˆåŠŸå“åº”**ï¼š`200`

  ```json
  {
    "success": true,
    "data": {
      "user": {
        "id": 1,
        "username": "alice",
        "email": "alice@example.com",
        "avatar_url": "/static/avatars/9be0d0c6.png",
        "last_login_at": "2025-10-10T00:11:22Z"
      },
      "settings": {
        "preferred_model": "gpt-4o-mini",
        "sync_enabled": true
      }
    }
  }
  ```

- **å¸¸è§é”™è¯¯**ï¼šè®¿é—®ä»¤ç‰Œç¼ºå¤±æˆ–è¿‡æœŸ â†’ `401`ã€‚

#### PUT /api/users/me

- **ç”¨é€”**ï¼šæ›´æ–°ç”¨æˆ·åã€é‚®ç®±ã€å¤´åƒæˆ–æ¨¡å‹åå¥½ï¼›è¯·æ±‚ä½“åªéœ€æºå¸¦éœ€è¦ä¿®æ”¹çš„å­—æ®µã€‚
- **è¯·æ±‚ä½“ç¤ºä¾‹**ï¼š

  ```json
  {
    "username": "alice-dev",
    "email": "alice.dev@example.com",
    "preferred_model": "deepseek",
    "sync_enabled": false,
    "avatar_url": ""
  }
  ```

  > å½“ `avatar_url` ä¼ å…¥ç©ºå­—ç¬¦ä¸²æ—¶ï¼Œåç«¯ä¼šæ¸…é™¤æ•°æ®åº“ä¸­çš„å¤´åƒåœ°å€ï¼Œå®ç°â€œç§»é™¤å¤´åƒâ€ã€‚

- **æˆåŠŸå“åº”**ï¼š`200`ï¼Œè¿”å›æ›´æ–°åçš„ `user` ä¸ `settings`ã€‚
- **å¸¸è§é”™è¯¯**ï¼š
  - é‚®ç®±æˆ–ç”¨æˆ·åè¢«å…¶ä»–è´¦å·å ç”¨ â†’ `409`ï¼Œ`error.details.fields` ä¼šåˆ—å‡ºå†²çªå­—æ®µã€‚
  - è¯·æ±‚ä½“ä¸ºç©ºæˆ–å­—æ®µæ ¼å¼ä¸æ­£ç¡® â†’ `400`ã€‚

#### POST /api/uploads/avatar

- **ç”¨é€”**ï¼šæŠŠå‰ç«¯é€‰ä¸­çš„å¤´åƒä¸Šä¼ åˆ° `public/avatars`ï¼Œè¿”å›å¯ä»¥ç«‹å³ä½¿ç”¨çš„é™æ€ URLã€‚
- **è¯·æ±‚ä½“**ï¼ˆmultipart/form-dataï¼‰ï¼š`avatar` æ–‡ä»¶å­—æ®µï¼Œæ”¯æŒ PNG/JPG/WEBPï¼Œå¤§å° â‰¤ 5 MBã€‚
- **æˆåŠŸå“åº”**ï¼š`201`

  ```json
  {
    "success": true,
    "data": {
      "avatar_url": "/static/avatars/6b94de26.png"
    }
  }
  ```

- **å¸¸è§é”™è¯¯**ï¼š
  - æœªä¸Šä¼ æ–‡ä»¶æˆ–å¤§å°ä¸º 0 â†’ `400`ã€‚
  - æ–‡ä»¶è¶…å‡ºå¤§å°é™åˆ¶æˆ– MIME ç±»å‹ä¸è¢«å…è®¸ â†’ `400`ã€‚
  - å­˜å‚¨ç›®å½•åˆ›å»ºå¤±è´¥æˆ–ç£ç›˜ä¸å¯å†™ â†’ `500`ã€‚

#### GET /static/avatars/<filename>

- **ç”¨é€”**ï¼šç›´æ¥è®¿é—®ç”¨æˆ·ä¸Šä¼ çš„å¤´åƒèµ„æºï¼›æ— éœ€é‰´æƒã€‚
- **é™æ€æ‰˜ç®¡**ï¼šç”± `router.go` çš„ `r.Static("/static", "./public")` æä¾›æœåŠ¡ï¼Œå¯æŒ‰éœ€æ”¹ä¸ºæŒ‡å‘å¯¹è±¡å­˜å‚¨æˆ– CDNã€‚

> **æç¤º**ï¼šå½“æŸä¸ªæ¨¡å‹å‡­æ®è¢«åˆ é™¤æˆ–ç¦ç”¨æ—¶ï¼Œè‹¥ç”¨æˆ·å½“å‰çš„ `preferred_model` æŒ‡å‘è¯¥æ¨¡å‹ï¼ŒæœåŠ¡ä¼šè‡ªåŠ¨å›é€€åˆ°é»˜è®¤å€¼ï¼ˆ`deepseek`ï¼‰ã€‚æ›´æ–°åå¥½æ—¶å¦‚æœè¯·æ±‚çš„æ¨¡å‹ä¸å­˜åœ¨æˆ–å¤„äºç¦ç”¨çŠ¶æ€ï¼Œä¼šè¿”å› `400 Bad Request` å¹¶åœ¨ `error.details.field` ä¸­æ ‡å‡º `preferred_model`ã€‚

#### GET /api/models

- **ç”¨é€”**ï¼šè¿”å›å½“å‰ç™»å½•ç”¨æˆ·å·²é…ç½®çš„æ‰€æœ‰æ¨¡å‹å‡­æ®ï¼Œä¾¿äºå‰ç«¯æ¸²æŸ“æ¨¡å‹åˆ—è¡¨ã€‚
- **æˆåŠŸå“åº”**ï¼š`200`

  ```json
  {
    "success": true,
    "data": {
      "models": [
        {
          "id": 1,
          "provider": "openai",
          "label": "GPT-4o",
          "metadata": {
            "default_model": "gpt-4o-mini"
          }
        }
      ]
    }
  }
  ```

- **å¸¸è§é”™è¯¯**ï¼šå°šæœªç™»å½• â†’ `401`ï¼›æ•°æ®åº“ä¸å¯ç”¨ â†’ `500`ã€‚

#### POST /api/models

- **ç”¨é€”**ï¼šåˆ›å»ºæ–°çš„æ¨¡å‹å‡­æ®ã€‚æœåŠ¡ç«¯ä¼šä½¿ç”¨ `MODEL_CREDENTIAL_MASTER_KEY` å¯¹ `api_key` è¿›è¡Œ AES-256-GCM åŠ å¯†åå…¥åº“ã€‚
- **è¯·æ±‚ä½“ç¤ºä¾‹**ï¼š

  ```json
  {
    "provider": "openai",
    "label": "ä¸»è´¦å·",
    "api_key": "sk-***",
    "metadata": {
      "default_model": "gpt-4o-mini"
    }
  }
  ```

- **æˆåŠŸå“åº”**ï¼š`201`ï¼Œè¿”å›æ–°å»ºè®°å½•çš„ IDã€‚
- **å¸¸è§é”™è¯¯**ï¼šç¼ºå°‘å¿…å¡«å­—æ®µ â†’ `400`ï¼›ä¸»å¯†é’¥æœªé…ç½® â†’ `500`ã€‚

#### PUT /api/models/:id

- **ç”¨é€”**ï¼šæ›´æ–°æ¨¡å‹æ ‡ç­¾ã€å…ƒæ•°æ®æˆ–æ›¿æ¢ API Keyã€‚è‹¥ä¼ å…¥æ–°çš„ `api_key`ï¼Œä¼šé‡æ–°åŠ å¯†æ›¿æ¢æ—§å€¼ï¼›å¦‚æœå­—æ®µä¸ºç©ºåˆ™ä¿æŒç°å€¼ã€‚
- **æˆåŠŸå“åº”**ï¼š`200`ï¼Œè¿”å›æ›´æ–°åçš„æ¨¡å‹ä¿¡æ¯ã€‚
- **å¸¸è§é”™è¯¯**ï¼šè®°å½•ä¸å­˜åœ¨ â†’ `404`ï¼›ä¸»å¯†é’¥æœªé…ç½® â†’ `500`ã€‚

#### DELETE /api/models/:id

- **ç”¨é€”**ï¼šåˆ é™¤æŒ‡å®šæ¨¡å‹å‡­æ®ï¼Œå¸¸ç”¨äºæ¸…ç†æ— æ•ˆæˆ–è¿‡æœŸçš„å¯†é’¥ã€‚
- **æˆåŠŸå“åº”**ï¼š`204`ã€‚
- **å¸¸è§é”™è¯¯**ï¼šè®°å½•ä¸å­˜åœ¨ â†’ `404`ã€‚

## å¯åŠ¨ä¸æµ‹è¯•

```powershell
cd backend
go run ./cmd/server
```

```powershell
cd backend
go test ./...
```

```powershell
cd backend
go test -tags integration ./tests/integration
```

> **è¯´æ˜ï¼š** å•å…ƒæµ‹è¯•ä¼šä½¿ç”¨å†…å­˜ç‰ˆ SQLite é©±åŠ¨ï¼Œé¿å…ä¾èµ–å¤–éƒ¨æ•°æ®åº“ï¼ŒåŒæ—¶ä¹Ÿç”¨äºéªŒè¯è‡ªåŠ¨è¿ç§»èƒ½æ­£ç¡®åˆ›å»º `user_model_credentials` ç­‰è¡¨ç»“æ„ã€‚

å¦‚éœ€è¿è¡Œå¸¦å¤–éƒ¨ä¾èµ–çš„é›†æˆæµ‹è¯•ï¼Œè¯·ç¡®ä¿ Nacos / MySQL å°±ç»ªå¹¶è¡¥å…¨å¯¹åº”ç¯å¢ƒå˜é‡ã€‚

## é¡¹ç›®ç»“æ„

```text
backend/
â”œâ”€ cmd/
â”‚  â”œâ”€ server/
â”‚  â”‚  â””â”€ main.go                 # åç«¯å…¥å£ï¼Œè´Ÿè´£åŠ è½½é…ç½®ä¸å¯åŠ¨ HTTP Server
â”‚  â””â”€ sendmail/
â”‚     â””â”€ main.go                 # é˜¿é‡Œäº‘ DirectMail è°ƒè¯•å‘½ä»¤
â”œâ”€ internal/
â”‚  â”œâ”€ app/
â”‚  â”‚  â””â”€ app.go                  # èµ„æºç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼ˆæ•°æ®åº“ã€ç¼“å­˜ç­‰ï¼‰
â”‚  â”œâ”€ bootstrap/
â”‚  â”‚  â””â”€ bootstrap.go            # ç»„è£…ä»“å‚¨ã€æœåŠ¡ã€Handlerã€Router
â”‚  â”œâ”€ config/
â”‚  â”‚  â””â”€ env_loader.go           # åŠ è½½ .env / ç¯å¢ƒå˜é‡
â”‚  â”œâ”€ domain/
â”‚  â”‚  â””â”€ user/
â”‚  â”‚     â””â”€ entity.go            # User å®ä½“ä¸ Settings ç»“æ„
â”‚  â”œâ”€ handler/
â”‚  â”‚  â”œâ”€ auth_handler.go         # /api/auth/* æ¥å£
â”‚  â”‚  â”œâ”€ user_handler.go         # /api/users/me æŸ¥è¯¢ä¸æ›´æ–°
â”‚  â”‚  â””â”€ upload_handler.go       # /api/uploads/avatar ä¸Šä¼ 
â”‚  â”œâ”€ infra/
â”‚  â”‚  â”œâ”€ captcha/
â”‚  â”‚  â”‚  â”œâ”€ config.go            # éªŒè¯ç é…ç½®è¯»å–
â”‚  â”‚  â”‚  â””â”€ manager.go           # éªŒè¯ç ç”Ÿæˆã€éªŒè¯ã€é™æµ
â”‚  â”‚  â”œâ”€ client/
â”‚  â”‚  â”‚  â”œâ”€ mysql_client.go      # MySQL è¿æ¥åˆå§‹åŒ–
â”‚  â”‚  â”‚  â”œâ”€ nacos_client.go      # Nacos å®¢æˆ·ç«¯
â”‚  â”‚  â”‚  â””â”€ redis_client.go      # Redis å®¢æˆ·ç«¯
â”‚  â”‚  â”œâ”€ common/response.go      # ç»Ÿä¸€å“åº”ä½“å°è£…
â”‚  â”‚  â”œâ”€ logger/logger.go        # Zap æ—¥å¿—åˆå§‹åŒ–
â”‚  â”‚  â”œâ”€ security/cipher.go      # AES-256-GCM åŠ è§£å¯†å·¥å…·
â”‚  â”‚  â””â”€ token/
â”‚  â”‚     â”œâ”€ jwt_manager.go       # Access Token ç­¾å‘
â”‚  â”‚     â””â”€ refresh_store.go     # åˆ·æ–°ä»¤ç‰Œå­˜å‚¨ï¼ˆRedis/å†…å­˜ï¼‰
â”‚  â”œâ”€ middleware/
â”‚  â”‚  â””â”€ auth_middleware.go      # Bearer Token é‰´æƒ
â”‚  â”œâ”€ repository/
â”‚  â”‚  â”œâ”€ user_repository.go      # User GORM æ“ä½œä¸å”¯ä¸€æ€§æ£€æŸ¥
â”‚  â”‚  â””â”€ model_credential_repository.go # æ¨¡å‹å‡­æ®æŒä¹…åŒ–
â”‚  â”œâ”€ server/
â”‚  â”‚  â””â”€ router.go               # Gin è·¯ç”±ã€CORSã€é™æ€èµ„æºé…ç½®
â”‚  â””â”€ service/
â”‚     â”œâ”€ auth/service.go         # æ³¨å†Œã€ç™»å½•ã€åˆ·æ–°ã€ç™»å‡ºé€»è¾‘
â”‚     â”œâ”€ user/service.go         # ç”¨æˆ·èµ„æ–™ã€è®¾ç½®æ›´æ–°
â”‚     â””â”€ model/service.go        # æ¨¡å‹å‡­æ®åŠ å¯†ä¸ä¸šåŠ¡é€»è¾‘
â”œâ”€ tests/
â”‚  â”œâ”€ unit/
â”‚  â”‚  â”œâ”€ auth_service_test.go
â”‚  â”‚  â”œâ”€ user_service_test.go
â”‚  â”‚  â”œâ”€ captcha_manager_test.go
â”‚  â”‚  â””â”€ response_helper_test.go
â”‚  â”œâ”€ integration/
â”‚  â”‚  â”œâ”€ auth_flow_integration_test.go
â”‚  â”‚  â”œâ”€ mysql_integration_test.go
â”‚  â”‚  â”œâ”€ nacos_integration_test.go
â”‚  â”‚  â””â”€ redis_integration_test.go
â”‚  â””â”€ e2e/
â”‚     â””â”€ auth_remote_e2e_test.go
â”œâ”€ public/
â”‚  â””â”€ avatars/
â”‚     â””â”€ .gitkeep                # å ä½æ–‡ä»¶ï¼Œè¿è¡Œæ—¶å¤´åƒä¿å­˜åœ¨æ­¤ç›®å½•
â””â”€ design/                       # PRDã€æµç¨‹å›¾ç­‰æ–‡æ¡£
```

éœ€è¦æ–°å¢æ¨¡å—æ—¶ï¼Œæ¨èæŒ‰ç…§ä¸Šè¿°åˆ†å±‚æ¨¡å¼æ‰©å±•ï¼Œä¿æŒ Handlerã€Serviceã€Repository ç­‰èŒè´£æ¸…æ™°ï¼Œå¹¶ä¼˜å…ˆåœ¨ `tests/` ä¸­è¡¥å……å¯¹åº”çš„å•å…ƒ/é›†æˆæµ‹è¯•ã€‚

## å¾…åŠä¸å®‰å…¨å¢å¼ºæ’æœŸ

- **é‚®ç®±æ ¡éªŒä¸éªŒè¯æµç¨‹**ï¼šæ–°å¢é‚®ç®±æ ¼å¼æ ¡éªŒã€ä¸­é—´å±‚é”™è¯¯æç¤ºï¼Œå¹¶æä¾›éªŒè¯é‚®ä»¶é“¾è·¯ï¼Œé˜²æ­¢ä¼ªé€ è´¦å·ã€‚
- **å¯†ç é‡ç½®**ï¼šè®¾è®¡ç”³è¯·é‡ç½®ã€é‚®ä»¶éªŒè¯ç ã€è®¾ç½®æ–°å¯†ç çš„å®Œæ•´æµç¨‹ï¼Œè¦†ç›–æœåŠ¡å±‚ä¸ Handler å•å…ƒæµ‹è¯•ã€‚
- **ç™»å½•é˜²æŠ¤**ï¼šè¡¥å……åŸºäº IP ä¸è´¦å·çš„é€Ÿç‡é™åˆ¶ï¼Œä»¥åŠå¯é€‰çš„ç™»å½•å¤±è´¥é»‘åå•ç­–ç•¥ã€‚
- **å®¡è®¡æ—¥å¿—**ï¼šè®°å½•æ•æ„Ÿæ“ä½œï¼ˆé‡ç½®å¯†ç ã€ä¿®æ”¹é‚®ç®±ã€ç™»å‡ºæ‰€æœ‰è®¾å¤‡ç­‰ï¼‰ï¼Œå¹¶æä¾›æŸ¥è¯¢æ¥å£ä»¥ä¾¿è¿½è¸ªã€‚

ä»¥ä¸Šæ¡ç›®åç»­ä¼šè¿›å…¥è¿­ä»£è®¡åˆ’ï¼Œä¼˜å…ˆå®ç°é‰´æƒæµç¨‹çš„å®Œæ•´é—­ç¯ã€‚
